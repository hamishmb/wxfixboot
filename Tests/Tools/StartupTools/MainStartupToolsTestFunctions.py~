#!/usr/bin/env python
# -*- coding: utf-8 -*- 
# MainStartupTools test functions for WxFixBoot Version 2.0.1
# This file is part of WxFixBoot.
# Copyright (C) 2013-2017 Hamish McIntyre-Bhatty
# WxFixBoot is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 3 or,
# at your option, any later version.
#
# WxFixBoot is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with WxFixBoot.  If not, see <http://www.gnu.org/licenses/>.

#If you're wondering why this is here, it's so that there are some known good/sane functions to aid testing the ones in DialogTools.

#Do future imports to prepare to support python 3. Use unicode strings rather than ASCII strings, as they fix potential problems.
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function
from __future__ import unicode_literals

WouldEmergencyExit = False
WouldEmergencyExitBecause = []

def EmergencyExit(Message):
    """Test suite special: sets a variable so the tests know if an Emergency Exit would have been triggered."""
    global WouldEmergencyExit
    global WouldEmergencyExitBecause

    WouldEmergencyExit = True
    WouldEmergencyExitBecause.append(Message)

def CheckDepends():
    """Check dependencies, and show an error message and kill the app if the dependencies are not met."""
    #Create a temporary list to allow WxFixBoot to notify the user of particular unmet dependencies.
    CmdList = ("cp", "mv", "which", "uname", "fsck", "ls", "modprobe", "mount", "umount", "rm", "ping", "badblocks", "arch", "python", "file", "sh", "echo", "lshw", "lvdisplay", "dmidecode", "chroot", "strings", "dd", "blkid")

    #Create a list to contain names of failed commands.
    FailedList = []

    for Command in CmdList:
        #Run the command with its argument and log the output (if in debug mode)
        Retval, Output = CoreTools.StartProcess("which "+Command, ReturnOutput=True)

        if Retval != 0:
            FailedList.append(Command)

    #Check if any commands failed.
    if FailedList != []:
        #Missing dependencies!
        EmergencyExit("The following dependencies could not be found on your system: "+', '.join(FailedList)+".\n\nPlease install the missing dependencies.")

def CheckForLiveDisk():
    """Try to determine if we're running on a live disk."""
    #Detect Parted Magic automatically.
    if "pmagic" in CoreTools.StartProcess("uname -r", ReturnOutput=True)[1]:
        SystemInfo["IsLiveDisk"] = True
        SystemInfo["OnPartedMagic"] = True

    #Try to detect ubuntu-based livecds.
    elif CoreTools.IsMounted("/cow", "/") and os.path.isfile("/cdrom/casper/filesystem.squashfs"):
        SystemInfo["IsLiveDisk"] = True
        SystemInfo["OnPartedMagic"] = False

    #Try to detect fedora-based livecds.
    elif CoreTools.IsMounted("/dev/mapper/live-rw", "/") and os.path.isfile("/run/initramfs/live/LiveOS/squashfs.img"):
        SystemInfo["IsLiveDisk"] = True
        SystemInfo["OnPartedMagic"] = False

    #Try to detect if we're not running on a live disk (on a HDD).
    elif "/dev/sd" in CoreTools.GetPartitionMountedAt("/"):
        SystemInfo["IsLiveDisk"] = False
        SystemInfo["OnPartedMagic"] = False

    #Try to detect if we're not running on a live disk (on LVM).
    elif "/dev/mapper/" in CoreTools.GetPartitionMountedAt("/"):
        SystemInfo["IsLiveDisk"] = False
        SystemInfo["OnPartedMagic"] = False

    #Ask the user if we're running on a live disk.
    else:
        SystemInfo["IsLiveDisk"] = DialogTools.ShowYesNoDlg(Message="Is WxFixBoot being run on live media, such as an Ubuntu Installer Disk?", Title="WxFixBoot - Live Media?")
        SystemInfo["OnPartedMagic"] = False

    #Get current OS architecture.
    SystemInfo["CurrentOSArch"] = CoreStartupTools.DetermineOSArchitecture(MountPoint="")

def GetOSs():
    """Get the names of all OSs on the HDDs."""
    RootFS = CoreTools.GetPartitionMountedAt("/")
    OSInfo = {}

    #Get Linux OSs.
    Keys = DiskInfo.keys()
    Keys.sort()

    for Partition in Keys:
        if DiskInfo[Partition]["Type"] == "Device":
            continue

        if DiskInfo[Partition]["FileSystem"] in ("vfat", "ntfs", "exfat"): pass #NOTE: Not fully implemented, will implement for v2.1. Disabled for now.
            #Look for Windows. NOTE: NTFS can't be mounted twice. ***OMITTED HERE.

        else:
            #Look for Linux.
            #The python command runs on python 2 and python 3.
            #If there are aliases for Partition, check if the root FS is one of those too.
            RootFSIsAlias = False

            if "Aliases" in DiskInfo[Partition]:
                if RootFS in DiskInfo[Partition]["Aliases"]:
                    RootFSIsAlias = True

                else:
                    RootFSIsAlias = False

            if Partition == RootFS or RootFSIsAlias:
                Cmd =  "python -c \"from __future__ import print_function; import platform; print(' '.join(platform.linux_distribution()));\""
                APTCmd = "which apt-get"
                YUMCmd = "which yum"
                Chroot = False
                IsCurrentOS = True
                MountPoint = ""

            else:
                MountPoint = "/tmp/wxfixboot/mountpoints"+Partition
                Cmd = "chroot "+MountPoint+" python -c \"from __future__ import print_function; import platform; print(' '.join(platform.linux_distribution()));\""
                APTCmd = "chroot "+MountPoint+" which apt-get"
                YUMCmd = "chroot "+MountPoint+" which yum"
                Chroot = True
                IsCurrentOS = False

                #Mount the partition and check if anything went wrong.
                if CoreTools.MountPartition(Partition=Partition, MountPoint=MountPoint) != 0:
                    #Ignore the partition.
                    continue

            #Look for Linux on this partition.
            Retval, Temp = CoreTools.StartProcess(Cmd, ReturnOutput=True)
            OSName = Temp.replace('\n', '')

            #Run the function to get the architechure.
            OSArch = CoreStartupTools.DetermineOSArchitecture(MountPoint=MountPoint)

            #If the OS's name wasn't found, but its architecture was, there must be an OS here, so try to use lsb_release if possible before asking the user. Catch if the name is just whitespace too.
            if (Retval != 0 or OSName == "" or OSName.isspace()) and OSArch != None:
                OSName = CoreStartupTools.GetOSNameWithLSB(Partition=Partition, MountPoint=MountPoint, IsCurrentOS=IsCurrentOS)

                #If we really have to, ask the user.
                if OSName == None:
                    OSName = CoreStartupTools.AskForOSName(Partition=Partition, OSArch=OSArch, IsCurrentOS=IsCurrentOS)

            #Look for APT.
            PackageManager = CoreStartupTools.DeterminePackageManager(APTCmd=APTCmd, YUMCmd=YUMCmd) 

            #Also check if CoreStartupTools.AskForOSName was used to determine the name. If the user skipped naming the OS, ignore it and skip the rest of this loop iteration.
            if OSName != None and OSArch != None and PackageManager != "Unknown":
                #Add this information to OSInfo.
                OSInfo[OSName] = {}
                OSInfo[OSName]["Name"] = OSName
                OSInfo[OSName]["IsCurrentOS"] = IsCurrentOS
                OSInfo[OSName]["Arch"] = OSArch
                OSInfo[OSName]["Partition"] = Partition
                OSInfo[OSName]["PackageManager"] = PackageManager
                OSInfo[OSName]["RawFSTabInfo"], OSInfo[OSName]["EFIPartition"], OSInfo[OSName]["BootPartition"] = CoreStartupTools.GetFSTabInfo(MountPoint, OSName)

                if Chroot == False:
                    SystemInfo["CurrentOS"] = OSInfo[OSName].copy()

            if Chroot:
                #Unmount the filesystem.
                if CoreTools.Unmount(MountPoint) != 0: break
                    #CoreTools.EmergencyExit("Couldn't unmount "+Partition+" after looking for operating systems on it! Please reboot your computer and try again.")

                #Remove the temporary mountpoint
                os.rmdir(MountPoint)

    #Check that at least one OS was detected.
    if len(OSInfo) >= 1:
        logger.debug("MainStartupTools: Main().GetOSs(): Done, OSInfo Populated okay. Contents: "+unicode(OSInfo))
        return OSInfo, SystemInfo

    else:
        logger.critical("MainStartupTools: Main().GetOSs(): No Linux installations found! If you do have Linux installations but WxFixBoot hasn't found them, please file a bug or ask a question on WxFixBoot's launchpad page. If you're using Windows or Mac OS X, then sorry as WxFixBoot has no support for these operating systems. You could instead use the tools provided by Microsoft and Apple to fix any issues with your computer. Exiting...")

        #Exit.
        CoreTools.EmergencyExit("You don't appear to have any Linux installations on your hard disks. If you do have Linux installations but WxFixBoot hasn't found them, please file a bug or ask a question on WxFixBoot's launchpad page. If you're using Windows or Mac OS X, then sorry as WxFixBoot has no support for these operating systems. You could instead use the tools provided by Microsoft and Apple to fix any issues with your computer.")
